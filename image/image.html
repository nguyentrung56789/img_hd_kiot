<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Render PNG (img_hd_kiot ‚ûú img_hd_kiot)</title>

<script src="./js/internal_key.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  html,body{margin:0;padding:0;background:#fff}
  #stage{background:#fff;width:794px;margin:auto}
</style>
</head>
<body>
<div id="stage"></div>
<script>
(async () => {
  try {
    if (typeof getConfig !== 'function') throw new Error('Thi·∫øu getConfig()');
    const SUPABASE_URL = getConfig('url');
    const ANON         = getConfig('anon');

    // === Bucket & file ===
    const BUCKET = 'img_hd_kiot';
    const HTML_KEY = 'img_hd.html';
    const PNG_KEY  = 'img_hd.png';

    // === URL ngu·ªìn & ƒë√≠ch ===
    const htmlUrl  = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${HTML_KEY}`;
    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/${BUCKET}/${PNG_KEY}`;
    const publicPngUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${PNG_KEY}`;

    // 1Ô∏è‚É£ T·∫£i HTML t·ª´ Supabase
    const resp = await fetch(htmlUrl, { mode: 'cors', cache: 'no-store' });
    if (!resp.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c HTML: ' + resp.status);
    const html = await resp.text();

    // 2Ô∏è‚É£ ƒê∆∞a HTML v√†o stage
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const styles   = [...doc.head.querySelectorAll('style')].map(s => s.outerHTML).join('\n');
    const bodyHTML = doc.body?.innerHTML || html;
    const stage = document.getElementById('stage');
    stage.innerHTML = styles + '\n' + bodyHTML;

    // 3Ô∏è‚É£ Ch·ªù t·∫•t c·∫£ ·∫£nh load xong
    await Promise.all([...stage.querySelectorAll('img')].map(i => 
      i.complete ? Promise.resolve() : new Promise(r => (i.onload = i.onerror = r))
    ));

    // 4Ô∏è‚É£ Render th√†nh PNG
    const canvas = await html2canvas(stage, {
      backgroundColor: '#fff',
      scale: 2,
      useCORS: true
    });
    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));

    // 5Ô∏è‚É£ Upload PNG (ghi ƒë√®)
    const up = await fetch(uploadUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getConfig('role')}`, // üîê L·∫•y key t·ª´ internal_key.js
        'Content-Type': 'image/png',
        'x-upsert': 'true'
      },
      body: blob
    });
    if (!up.ok) {
      const t = await up.text().catch(() => '');
      throw new Error('Upload PNG l·ªói: ' + up.status + ' ' + t);
    }

    // 6Ô∏è‚É£ K·∫øt qu·∫£
    console.log('‚úÖ PNG uploaded:', publicPngUrl);
    document.body.innerHTML = `<p style="font-family:monospace;text-align:center;margin-top:30px">
      ‚úÖ Render & Upload th√†nh c√¥ng<br>
      <a href="${publicPngUrl}" target="_blank">${publicPngUrl}</a>
    </p>`;

  } catch (e) {
    console.error(e);
    document.body.innerText = '‚ùå L·ªói: ' + (e.message || e);
  }
})();
</script>
</body>
</html>
